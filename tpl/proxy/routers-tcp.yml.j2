# yaml-language-server: $schema=https://www.schemastore.org/traefik-v3.json
tcp:
  routers:
{%- for p in projects %}
  {%- for s in p.services %}
    {%- for i in s.ingress %}
      {%- set name = p.name ~ '-' ~ s.host.replace('.', '-') ~ '-' ~ i.port %}
    {{ name }}:
      entryPoints:
      {%- if i.hostport == 443 %}
        - tcp-secure
      {%- elif i.hostport %}
        - tcp-{{ i.hostport }}
      {%- else %}
        - tcp-secure
      {%- endif %}
      {%- if i.domain %}
      rule: 'HostSNI(`{{ i.domain }}`){% if i.path_prefix %} && PathPrefix(`{{ i.path_prefix }}`){% endif %}'
      {%- else %}
      rule: 'HostSNI(`*`)'
      {%- endif %}
      rulesyntax: v2
      service: {{ name }}
      {%- if i.passthrough %}
      tls:
        passthrough: true
      {%- elif i.domain or i.tls %}
      tls:
        certresolver: letsencrypt
      {%- endif %}
    {%- endfor %}
  {%- endfor %}
{%- endfor %}
    http:
      entryPoints:
        - tcp
      service: http
      rule: 'HostSNI(`*`)'
    https:
      entryPoints:
        - tcp-secure
      service: https
      rule: 'HostSNI(`*`)'
      tls:
        passthrough: true

  services:
{%- for p in projects %}
  {%- for s in p.services %}
    {%- for i in s.ingress %}
      {%- set name = p.name ~ '-' ~ s.host.replace('.', '-') ~ '-' ~ i.port %}
    {{ name }}:
      loadBalancer:
        proxyProtocol:
          version: 2
        servers:
          - address: {% if s.image %}{{ p.name }}-{% endif %}{{ s.host }}:{{ i.port }}
    {%- endfor %}
  {%- endfor %}
{%- endfor %}
    http:
      loadBalancer:
        proxyProtocol:
          version: 2
        servers:
          - address: traefik-web:8080
    https:
      loadBalancer:
        proxyProtocol:
          version: 2
        servers:
          - address: traefik-web:8443
