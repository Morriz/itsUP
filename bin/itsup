#!/usr/bin/env python3

"""
itsUP CLI - Command-line interface for itsUP management

Usage:
    itsup init                  Initialize "projects" and "secrets" repos from samples
    itsup status                Show git status for "projects" and "secrets" repos
    itsup commit <msg>          Commit and push changes to "projects" and "secrets" repos
    itsup run                   Run complete stack (orchestrated: dns→proxy→api→monitor)
    itsup down                  Stop ALL containers: DNS, proxy, AND upstream projects (in parallel)
    itsup down --clean          Same as down + remove stopped itsUP containers (in parallel)
    itsup dns <cmd>             DNS stack management (up/down/restart/logs)
    itsup proxy <cmd>           Proxy stack management (up/down/restart/logs)
    itsup apply                 Apply configs to upstream projects only (regenerate + deploy in parallel)
    itsup apply <project>       Apply config to single upstream project
    itsup svc <proj> <cmd>      Project service operations (docker compose passthrough)
    itsup validate              Validate project configurations
    itsup migrate               Migrate configuration schema to latest version
    itsup monitor               Container security monitor management
    itsup --version             Show version
    itsup --help                Show help
"""

import sys
import click
from pathlib import Path

# Add project root to Python path for imports
# itsup is in bin/, so project root is parent of bin/
project_root = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(project_root))


from lib.logging_config import setup_logging
from commands.init import init
from commands.status import status
from commands.commit import commit
from commands.run import run
from commands.down import down
from commands.dns import dns
from commands.proxy import proxy
from commands.apply import apply
from commands.svc import svc
from commands.validate import validate
from commands.migrate import migrate_cmd
from commands.monitor import monitor
from commands.logs import logs
from commands.encrypt import encrypt
from commands.decrypt import decrypt
from commands.diff_secrets import diff_secrets
from commands.edit_secret import edit_secret
from commands.sops_key import sops_key


@click.group(context_settings=dict(allow_interspersed_args=False))
@click.version_option(version="2.1.1", prog_name="itsup")
@click.option("--verbose", "-v", count=True, help="Verbosity: -v (DEBUG), -vv (TRACE)", is_eager=True)
def cli(verbose):
    """itsUP - Infrastructure management CLI"""
    # Map verbosity count to log levels (CLI ignores LOG_LEVEL env var)
    # 0 = INFO (default - show info and errors)
    # 1 = DEBUG (-v)
    # 2+ = TRACE (-vv)
    if verbose == 0:
        level = "INFO"
    elif verbose == 1:
        level = "DEBUG"
    else:  # 2+
        level = "TRACE"

    setup_logging(level=level)


# Register commands
cli.add_command(init)
cli.add_command(status)
cli.add_command(commit)
cli.add_command(run)
cli.add_command(down)
cli.add_command(dns)
cli.add_command(proxy)
cli.add_command(apply)
cli.add_command(svc)
cli.add_command(validate)
cli.add_command(migrate_cmd, name="migrate")
cli.add_command(monitor)
cli.add_command(logs)
cli.add_command(encrypt)
cli.add_command(decrypt)
cli.add_command(diff_secrets)
cli.add_command(edit_secret)
cli.add_command(sops_key)

if __name__ == "__main__":
    cli()
