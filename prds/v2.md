# itsUP V2 - Product Requirements Document

## Status

**Current:** V2 partially implemented on `v2-migration` branch
**Target:** Complete V2, test, merge to main, deprecate db.yml

---

## Executive Summary

V2 migrates from monolithic `db.yml` to a git-based projects/ structure where:

- Each project has `docker-compose.yml` + `ingress.yml`
- Infrastructure config in `projects/traefik.yml` (user overrides)
- Secrets in encrypted `secrets/` submodule
- Everything committed to git except SOPS key

**Benefits:**

- Shareable infrastructure (public projects/ repo)
- Standard docker-compose.yml format
- Clear secret separation
- Version control for all config

---

## What's Implemented ✅

### V2 Data Model

- ✅ `IngressV2` model for routing config
- ✅ `TraefikConfig` model for project ingress
- ✅ `load_project()` - loads docker-compose.yml + ingress.yml
- ✅ `inject_traefik_labels()` - generates Traefik labels from ingress.yml
- ✅ `write_upstream()` - writes upstream/{project}/docker-compose.yml with labels

### V2 CLI

- ✅ Stack commands: `itsup dns`, `itsup proxy`, `itsup svc`
- ✅ Orchestrated: `itsup run` (dns→proxy→api→monitor)
- ✅ Project operations: `itsup svc <project> up/down/logs`

### File Structure

- ✅ `projects/{name}/docker-compose.yml` - service definitions
- ✅ `projects/{name}/ingress.yml` - routing config
- ✅ `samples/example-project/` - template for new projects
- ✅ `samples/traefik.yml` - infrastructure override template

---

## What's Missing ❌

### Proxy Artifact Generation

**Status:** Partially implemented in `bin/write_artifacts.py` but missing data sources

**Needs:**

- Read infrastructure config from .env (temporary solution)
- Generate `proxy/docker-compose.yml` from `tpl/proxy/docker-compose.yml.j2`
- Generate `proxy/traefik/traefik.yml` from template + merge `projects/traefik.yml` overrides
- Generate `proxy/traefik/dynamic/routers-*.yml` for static routes

**Blockers:**

- Removed V1 functions `get_plugin_registry()`, `get_versions()`, `get_projects()`
- Need .env-based config loading for plugins, versions, trusted IPs

### Init Command

**Status:** Not implemented

**Needs:**

```bash
itsup init
  - Check projects/ and secrets/ submodules exist
  - Copy samples/env → .env
  - Copy samples/traefik.yml → projects/traefik.yml
  - Copy samples/secrets/itsup.txt → secrets/itsup.txt
  - Show next steps
```

### db.yml Migration

**Status:** db.yml still exists, not yet migrated

**Needs:**

- Migration script to convert db.yml → projects/ structure
- Extract per-project configs → projects/{name}/
- Extract infrastructure config → projects/traefik.yml
- Extract secrets → secrets/
- Delete db.yml when done

---

## Implementation Plan

### Phase 1: Complete Proxy Generation (Week 1)

**Goal:** Test V2 works without db.yml

**Tasks:**

1. Add .env config loading for proxy generation

   ```bash
   # .env
   LETSENCRYPT_EMAIL=admin@example.com
   LETSENCRYPT_STAGING=false
   DOMAIN_SUFFIX=example.com
   TRUSTED_IPS_CIDRS=127.0.0.1/32,192.168.1.1/32
   TRAEFIK_VERSION=v3.2
   CROWDSEC_VERSION=v1.6.8
   CROWDSEC_ENABLED=false
   ```

2. Update `bin/write_artifacts.py`:

   - Read from .env instead of db.yml
   - Generate proxy/docker-compose.yml
   - Generate proxy/traefik/traefik.yml (merge with projects/traefik.yml)
   - Generate proxy/traefik/dynamic/routers-\*.yml

3. Test artifact generation:

   ```bash
   bin/write_artifacts.py
   # Should generate all proxy and upstream artifacts
   ```

4. Test full stack:
   ```bash
   itsup run
   # Should start dns→proxy→api→monitor successfully
   ```

**Success Criteria:**

- ✅ `bin/write_artifacts.py` completes without errors
- ✅ `itsup run` starts full stack
- ✅ Traefik dashboard accessible
- ✅ No db.yml dependencies

---

### Phase 2: Init Command (Week 2)

**Goal:** New users can initialize from samples

**Tasks:**

1. Create `commands/init.py`:

   - Validate submodules
   - Copy sample files
   - Show next steps

2. Update README with init workflow

3. Test init on fresh clone

**Success Criteria:**

- ✅ `itsup init` creates all necessary files
- ✅ User can follow steps to deploy
- ✅ Documentation accurate

---

### Phase 3: db.yml Migration (Week 3)

**Goal:** Migrate existing db.yml to V2 structure

**Tasks:**

1. Create `bin/migrate-db-to-v2.py`:

   - Parse db.yml
   - Extract infrastructure config → projects/traefik.yml
   - Extract per-project configs → projects/{name}/
   - Extract secrets → secrets/{name}.txt
   - Show diff between old and new

2. Test migration:

   - Run migration script
   - Compare generated artifacts
   - Verify functionality

3. Delete db.yml

**Success Criteria:**

- ✅ Migration script produces identical runtime behavior
- ✅ All projects work after migration
- ✅ db.yml deleted from repo

---

## V2 Architecture

### File Structure

```
Main Repo (itsUP):
├── .env                           # Runtime config (from samples/env)
├── samples/
│   ├── env                       # Runtime config template
│   ├── traefik.yml               # Infrastructure override template
│   ├── secrets/itsup.txt        # Secrets template
│   └── example-project/
│       ├── docker-compose.yml    # Project template
│       └── ingress.yml           # Routing template
├── commands/
│   ├── init.py                   # NEW: Initialize from samples
│   ├── run.py                    # Orchestrated startup
│   ├── dns.py                    # DNS stack commands
│   ├── proxy.py                  # Proxy stack commands
│   └── svc.py                    # Project service commands
├── lib/
│   ├── data.py                   # V2 data loading
│   └── models.py                 # IngressV2, TraefikConfig
├── tpl/proxy/
│   ├── docker-compose.yml.j2     # Proxy stack template
│   ├── traefik.yml.j2            # Traefik config template
│   └── routers-*.yml.j2          # Dynamic routing templates
└── bin/
    └── write_artifacts.py        # Generate all artifacts

Submodule: projects/ (PUBLIC):
├── traefik.yml                    # Infrastructure overrides (from samples/)
└── {project}/
    ├── docker-compose.yml         # Standard docker compose
    └── ingress.yml                # Routing config (IngressV2)

Submodule: secrets/ (PRIVATE):
├── itsup.enc.txt                 # SOPS encrypted
└── {project}.enc.txt              # SOPS encrypted

Generated (gitignored):
├── dns/docker-compose.yml         # DNS stack
├── proxy/
│   ├── docker-compose.yml         # Proxy stack
│   └── traefik/
│       ├── traefik.yml            # Static config
│       └── dynamic/
│           ├── routers-http.yml   # HTTP routes
│           ├── routers-tcp.yml    # TCP routes
│           └── routers-udp.yml    # UDP routes
└── upstream/{project}/
    └── docker-compose.yml         # With Traefik labels
```

### Data Flow

```
1. Load project:
   projects/{name}/docker-compose.yml + projects/{name}/ingress.yml
   ↓ load_project()
   ↓ inject_traefik_labels()
   → upstream/{name}/docker-compose.yml (with Traefik labels)

2. Generate proxy:
   .env + projects/traefik.yml + tpl/proxy/*
   ↓ write_proxy_artifacts()
   → proxy/docker-compose.yml
   → proxy/traefik/traefik.yml (merged with user overrides)
   → proxy/traefik/dynamic/routers-*.yml

3. Deploy:
   itsup run
   ↓ dns up → proxy up → api start → monitor start
   → Full stack running
```

---

## Configuration Schema

### projects/{name}/ingress.yml

```yaml
enabled: true

ingress:
  - service: web # Service name in docker-compose.yml
    domain: example.com # Domain for routing
    port: 80 # Container port
    router: http # http, tcp, or udp
    path_prefix: /api # Optional path prefix
    hostport: 8080 # Optional host port binding
    passthrough: false # TLS passthrough mode
```

### projects/traefik.yml (Infrastructure Overrides)

Uses native Traefik YAML schema - merged on top of generated config:

```yaml
# Override log level
log:
  level: DEBUG

# Override certificate resolver
certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@example.com

# Override trusted IPs
entryPoints:
  web:
    forwardedHeaders:
      trustedIPs:
        - 192.168.1.1/32
```

### .env (Runtime Config)

```bash
# Infrastructure
LETSENCRYPT_EMAIL=admin@example.com
LETSENCRYPT_STAGING=false
DOMAIN_SUFFIX=example.com
TRUSTED_IPS_CIDRS=127.0.0.1/32,192.168.1.1/32

# Versions
TRAEFIK_VERSION=v3.2
CROWDSEC_VERSION=v1.6.8

# Plugins
CROWDSEC_ENABLED=false
CROWDSEC_API_KEY=

# Traefik Dashboard
TRAEFIK_DOMAIN=traefik.example.com
TRAEFIK_ADMIN=admin:htpasswd_hash
```

---

## Testing Strategy

### Unit Tests

- `lib/data_test.py` - load_project, validate functions
- `bin/write_artifacts_test.py` - artifact generation
- `commands/*_test.py` - CLI command logic

### Integration Tests

1. Fresh init test:

   ```bash
   itsup init
   # Edit sample configs
   itsup run
   # Verify all services start
   ```

2. Project deployment test:

   ```bash
   # Create test project
   itsup svc test-app up
   # Verify Traefik labels generated
   # Verify routing works
   ```

3. Migration test:
   ```bash
   # Backup db.yml
   bin/migrate-db-to-v2.py
   # Compare artifacts
   itsup run
   # Verify identical behavior
   ```

---

## Success Criteria

**Phase 1 Complete:**

- [ ] V2 works without db.yml dependencies
- [ ] All proxy artifacts generate from .env config
- [ ] Full stack starts via `itsup run`
- [ ] Tests passing

**Phase 2 Complete:**

- [ ] `itsup init` command works
- [ ] New users can initialize from samples
- [ ] Documentation updated

**Phase 3 Complete:**

- [ ] db.yml successfully migrated to V2
- [ ] Migration script tested and validated
- [ ] db.yml removed from repository
- [ ] V2 merged to main branch

---

## Migration Timeline

| Phase               | Duration | Deliverable                    |
| ------------------- | -------- | ------------------------------ |
| 1. Proxy Generation | 1 week   | V2 works without db.yml        |
| 2. Init Command     | 1 week   | `itsup init` functional        |
| 3. db.yml Migration | 1 week   | Migration complete, V2 on main |

**Total:** 3 weeks to complete V2 migration

---

## Open Questions

1. **CrowdSec config location?**

   - Option A: Stay in .env (simpler)
   - Option B: Move to projects/crowdsec.yml (more structured)
   - **Recommendation:** .env for now, refactor later if needed

2. **projects/traefik.yml schema?**

   - ✅ DECIDED: Use native Traefik YAML (for deep merge compatibility)

3. **Versioning strategy?**

   - Option A: .env only
   - Option B: projects/versions.yml
   - **Recommendation:** .env for now

4. **Migration automation?**
   - Should migration script run automatically on first V2 command?
   - Or require explicit `itsup migrate-from-v1`?
   - **Recommendation:** Explicit command for safety

---

## Risk Mitigation

**Risk:** Proxy generation doesn't work without db.yml
**Mitigation:** Phase 1 tests this immediately, minimal .env config

**Risk:** Migration script loses data
**Mitigation:** Comprehensive diff tool, backup db.yml before migration

**Risk:** Breaking changes for existing deployments
**Mitigation:** Keep V1 in separate branch, test V2 in staging first

**Risk:** Documentation lag
**Mitigation:** Update docs in each phase, not at end
